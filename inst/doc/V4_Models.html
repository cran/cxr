<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="David Garcia-Callejas and cxr team" />


<title>Using your own models</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Using your own models</h1>
<h4 class="author">David Garcia-Callejas and cxr team</h4>



<p>One of the design principles of <code>cxr</code> is to allow users to
estimate parameters from their own models. <code>cxr</code> already
includes four families of well-known population dynamic models:
Beverton-Holt (BH), Lotka-Volterra (LV), Ricker (RK), and Law-Watkinson
(LW), all in their discrete time formulation (see the accompanying
publication of <code>cxr</code> for formulation of these general
families). Users can choose between these default families by setting
the <code>model_family</code> argument to the acronym of the chosen
model. In this vignette we show, step by step, how other user-defined
models can be integrated in the package.</p>
<p>First of all, a common feature of the families included is that they
rely on a common set of parameters, namely
<code>lambda</code>,<code>alpha</code> (separated in
<code>alpha_intra</code> and <code>alpha_inter</code>),
<code>lambda_cov</code>, and <code>alpha_cov</code>. For now,
user-defined models within <code>cxr</code> must be restricted to these
parameters. A detailed description of these parameters can be found in
previous vignettes. This does not preclude users to hard-code other
model parameters inside the model functions, and future releases will
aim to relax this assumption.</p>
<p>At the end of this vignette we include the full R code of a model
template that can be used directly into <code>cxr</code>. This template
is also included as a stand-alone R file in the source files of the
package (<code>cxr_model_template.R</code>), and here we first explain
each section of it.</p>
<p>First, model functions should be defined with the common set of
arguments recognized by <code>cxr</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>family_pm_alpha_form_lambdacov_form_alphacov_form <span class="ot">&lt;-</span> <span class="cf">function</span>(par,</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>                                                              fitness,</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>                                                              <span class="at">neigh_intra_matrix =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>                                                              neigh_inter_matrix,</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>                                                              covariates,</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>                                                              fixed_parameters)</span></code></pre></div>
<p>Assuming data for <span class="math inline">\(n\)</span> observations
of a focal species and <span class="math inline">\(s\)</span> neighbour
species (including itself), the function arguments are:</p>
<ul>
<li><em>par</em>: one-dimensional numeric vector including all
parameters to fit.</li>
<li><em>fitness</em>: one-dimensional vector of length <span class="math inline">\(n\)</span> with fitness observations in log
scale.</li>
<li><em>neigh_intra_matrix</em>: matrix of <span class="math inline">\(n\)</span> rows and 1 column, with observations of
intraspecific neighbours.</li>
<li><em>neigh_inter_matrix</em>: matrix of <span class="math inline">\(n\)</span> rows and <span class="math inline">\(s-1\)</span> columns, with observations of
interspecific neighbours.</li>
<li><em>covariates</em>: dataframe with <span class="math inline">\(n\)</span> rows and as many columns as
covariates.</li>
<li><em>fixed_parameters</em>: list with values of parameters that are
not to be fitted.</li>
</ul>
<p>the name of the function should be adapted to the parameters you want
to fit:</p>
<ul>
<li><em>‘family’</em> is the two-letter acronym of your model
family.</li>
<li><em>‘alpha_form’</em> is one of ‘alpha_none’,‘alpha_global’, or
‘alpha_pairwise’, depending on whether no alphas, a single alpha, or
pairwise alphas are included in your model.</li>
<li><em>‘lambda_cov_form’</em> is one of ‘lambda_cov_none’ or
‘lambda_cov_global’, depending on whether you include the effect of
covariates over lambda.</li>
<li><em>‘alpha_cov_form’</em> is one of ‘alpha_cov_none’,
‘alpha_cov_global’, or ‘alpha_cov_pairwise’, depending on whether and
how to include the effect of covariates over alpha values: no inclusion,
a global parameter for each covariate on the alpha values, or
interaction-specific parameters for each covariate.</li>
</ul>
<p>Thus, if you code a model from your User Model (UM) family that
includes pairwise alphas, but no effects of covariates over lambda or
alpha, your function must be named as:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>UM_pm_alpha_pairwise_lambdacov_none_alphacov_none <span class="ot">&lt;-</span> <span class="cf">function</span>(par,</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>                                                              fitness,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>                                                              <span class="at">neigh_intra_matrix =</span> <span class="cn">NULL</span>,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>                                                              neigh_inter_matrix,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>                                                              covariates,</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>                                                              fixed_parameters)</span></code></pre></div>
<p>The first step inside the function is to retrieve the different
parameters from the one-dimensional <code>par</code> vector. You should
not have to change this section except for commenting or commenting out
the section where parameters are retrieved. For example, if your model
does not include <code>lambda_cov</code> or <code>alpha_cov</code>, you
should comment their sections. Note that it includes a final parameter,
sigma, that should always be there, as it keeps track of the error
associated to the fit.</p>
<p>This is how this part in your
‘UM_pm_alpha_pairwise_lambdacov_none_alphacov_none’ model would look
like:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># retrieve parameters -----------------------------------------------------</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co"># parameters to fit are all in the &quot;par&quot; vector,</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co"># so we need to retrieve them one by one</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># order is {lambda,lambda_cov,alpha,alpha_cov,sigma}</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co"># comment or uncomment sections for the different parameters</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co"># depending on whether your model includes them</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co"># note that the section on alpha_inter includes two</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co"># possibilities, depending on whether a single alpha is </span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co"># fitted for all interactions (global) or each pairwise alpha is </span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co"># different (pairwise)</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="co"># both are commented, you need to uncomment the appropriate one</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="co"># likewise for the section on alpha_cov</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co"># --------------------------------------------------------------------------</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>pos <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co"># if a parameter is passed within the &quot;par&quot; vector,</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="co"># it should be NULL in the &quot;fixed_parameters&quot; list</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a><span class="co"># lambda</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters<span class="sc">$</span>lambda)){</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> par[pos]</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>  pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;lambda&quot;</span>]]</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>}</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a><span class="co"># lambda_cov</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a><span class="co"># if(is.null(fixed_parameters$lambda_cov)){</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a><span class="co">#   lambda_cov &lt;- par[pos:(pos+ncol(covariates)-1)]</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a><span class="co">#   pos &lt;- pos + ncol(covariates)</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="co"># }else{</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a><span class="co">#   lambda_cov &lt;- fixed_parameters[[&quot;lambda_cov&quot;]]</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a><span class="co"># alpha_intra</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(neigh_intra_matrix)){</span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>  <span class="co"># intra</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters[[<span class="st">&quot;alpha_intra&quot;</span>]])){</span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>    alpha_intra <span class="ot">&lt;-</span> par[pos]</span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>    alpha_intra <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;alpha_intra&quot;</span>]]</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>  }</span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>  alpha_intra <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>}</span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a><span class="co"># alpha_inter</span></span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters[[<span class="st">&quot;alpha_inter&quot;</span>]])){</span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a>  <span class="co"># uncomment for alpha_global</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a>  <span class="co"># alpha_inter &lt;- par[pos]</span></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a>  <span class="co"># pos &lt;- pos + 1</span></span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>  </span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>  <span class="co"># uncomment for alpha_pairwise</span></span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a>  alpha_inter <span class="ot">&lt;-</span> par[pos<span class="sc">:</span>(pos<span class="sc">+</span><span class="fu">ncol</span>(neigh_inter_matrix)<span class="sc">-</span><span class="dv">1</span>)]</span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a>  pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="fu">ncol</span>(neigh_inter_matrix)</span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>  alpha_inter <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;alpha_inter&quot;</span>]]</span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a>}</span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a></span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a><span class="co"># alpha_cov</span></span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a><span class="co"># if(is.null(fixed_parameters$alpha_cov)){</span></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a><span class="co">#   # uncomment for alpha_cov_global</span></span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a><span class="co">#   # alpha_cov &lt;- par[pos:(pos+ncol(covariates)-1)]</span></span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a><span class="co">#   # pos &lt;- pos + ncol(covariates)</span></span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a><span class="co">#   # uncomment for alpha_cov_pairwise</span></span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a><span class="co">#   # alpha_cov &lt;- par[pos:(pos+(ncol(covariates)*</span></span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a><span class="co">#   # (ncol(neigh_inter_matrix)+ncol(neigh_intra_matrix)))-1)]</span></span>
<span id="cb3-74"><a href="#cb3-74" tabindex="-1"></a><span class="co">#   # pos &lt;- pos + (ncol(covariates)*(ncol(neigh_inter_matrix)+ncol(neigh_intra_matrix)))</span></span>
<span id="cb3-75"><a href="#cb3-75" tabindex="-1"></a><span class="co"># }else{</span></span>
<span id="cb3-76"><a href="#cb3-76" tabindex="-1"></a><span class="co">#   alpha_cov &lt;- fixed_parameters[[&quot;alpha_cov&quot;]]</span></span>
<span id="cb3-77"><a href="#cb3-77" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb3-78"><a href="#cb3-78" tabindex="-1"></a></span>
<span id="cb3-79"><a href="#cb3-79" tabindex="-1"></a><span class="co"># sigma - this is always necessary</span></span>
<span id="cb3-80"><a href="#cb3-80" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> par[<span class="fu">length</span>(par)]</span></code></pre></div>
<p>At this point, you can code your model. This is how the equivalent
Beverton-Holt model looks like, for reference:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># MODEL CODE HERE ---------------------------------------------------------</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"># the model should return a &quot;pred&quot; value</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co"># a function of lambda, alpha_intra, alpha_inter, lambda_cov, alpha_cov </span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co"># and neigh_intra_matrix, neigh_inter_matrix, and covariates</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co"># we do not differentiate alpha_intra from alpha_inter in this model</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co"># so, put together alpha_intra and alpha_inter, and the observations</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co"># with intraspecific ones at the beginning</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(alpha_intra)){</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> <span class="fu">c</span>(alpha_intra,alpha_inter)</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>  all_neigh_matrix <span class="ot">&lt;-</span> <span class="fu">cbind</span>(neigh_intra_matrix,neigh_inter_matrix)</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> alpha_inter</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  all_neigh_matrix <span class="ot">&lt;-</span> neigh_inter_matrix</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>}</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>term <span class="ot">=</span> <span class="dv">1</span> <span class="co">#create the denominator term for the model</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a><span class="cf">for</span>(z <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(all_neigh_matrix)){</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>  term <span class="ot">&lt;-</span> term <span class="sc">+</span> alpha[z]<span class="sc">*</span>all_neigh_matrix[,z] </span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>}</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>pred <span class="ot">&lt;-</span> lambda<span class="sc">/</span> term</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="co"># MODEL CODE ENDS HERE ----------------------------------------------------</span></span></code></pre></div>
<p>Note how there are no hard-coded checks for ensuring that alpha
values and neigh_matrix values are appropriately sorted. These checks
are performed in the <code>cxr_pm_fit</code> function that internally
sorts data and call this model for optimization.</p>
<p>The last part of the model function is returning the negative
log-likelihood value for that particular parameter combination. This is
the value that the numerical optimization algorithms aim to minimize. In
general, you should not need to change this code.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># the routine returns the sum of negative log-likelihoods of the data and model:</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co"># DO NOT CHANGE THIS</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>llik <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(fitness, <span class="at">mean =</span> (<span class="fu">log</span>(pred)), <span class="at">sd =</span> (sigma), <span class="at">log=</span><span class="cn">TRUE</span>)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="fu">return</span>(<span class="fu">sum</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>llik))</span></code></pre></div>
<p>When you have a functioning model, you should be able to use it
within <code>cxr</code> as soon as you load your model into the global
environment, which can be done simply by ‘sourcing’ your R file named
with the name of your model,
i.e. ‘UM_pm_alpha_pairwise_lambdacov_none_alphacov_none.R’ in our
example.</p>
<p>Thus, for fitting a certain dataset with your custom model, you would
call the <code>cxr_pm_fit</code> function with the appropriate
parameters:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># load your model into the global environment</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;./pm_UM_alpha_pairwise_lambdacov_none_alphacov_none.R&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co"># fit your data</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>custom_fit <span class="ot">&lt;-</span> <span class="fu">cxr_pm_fit</span>(<span class="at">data =</span> custom_data, <span class="co"># assuming custom_data is already set...</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>                         <span class="at">focal_column =</span> my_focal, <span class="co"># assuming my_focal is already set...</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>                         <span class="at">model_family =</span> <span class="st">&quot;UM&quot;</span>,</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>                         <span class="at">covariates =</span> <span class="cn">NULL</span>, <span class="co"># as we have no covariate effects</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>                         <span class="at">alpha_form =</span> <span class="st">&quot;pairwise&quot;</span>,</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>                         <span class="at">lambda_cov_form =</span> <span class="st">&quot;none&quot;</span>,</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>                         <span class="at">alpha_cov_form =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p>If the function cannot find a model matching the provided
‘model_family’,‘alpha_form’,‘lambda_cov_form’, and ‘alpha_cov_form’, it
will output a message and return NULL. On a final note, if you think
your bright new model can be useful for fellow scientists, we encourage
you to make a pull request for integrating it in the set of default
model families included in <code>cxr</code>. An interesting update to
the package would be, in addition to include other model families, to
implement non-linear relationships of covariate effects over lambda and
alpha values.</p>
<p>There are several issues that you should have in mind when developing
custom models. First, recall that numerical optimization methods may be
bounded or unbounded. If your model does not return meaningful values
for part of the parameter space defined by the hypervolume of parameter
boundaries, bounded optimization methods (such as ‘L-BFGS-B’ or
‘bobyqa’) may fail. This is well exemplified by the discrete
Lotka-Volterra model:</p>
<p><span class="math inline">\(\lambda_i - \alpha_{ii}N_i -
\alpha_{ij}Nj\)</span></p>
<p>which can easily produce negative values and thus undefined
log-likelihoods. The second point to note is that user-defined
population dynamics models are sufficient to obtain tailored lambda and
alpha values, but importantly, several MCT metrics are also
model-specific.</p>
<p><strong>Model-specific coexistence metrics</strong></p>
<p>Among the coexistence metrics that can be calculated with
<code>cxr</code>, five of them are model-specific, i.e. have different
formulations depending on the underlying population dynamics model from
which lambda and alpha values are obtained. These are:</p>
<ul>
<li>demographic ratio (and therefore, average fitness differences in the
MCT formulation)</li>
<li>competitive ability</li>
<li>competitive effects and responses</li>
<li>species fitness in the absence of niche differences</li>
</ul>
<p>All these have different formulations for different model families.
Therefore, if you want to estimate coexistence metrics based on custom
models, you should provide a full set of formulations for these metrics.
Here we show their formulation for Beverton-Holt models, for reference.
The supplementary material of Godoy and Levine (2014) and that of Hart
et al. (2018) are good places to explore the mathematical underpinnings
of these particularities.</p>
<ul>
<li>demographic ratio:</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>BH_demographic_ratio <span class="ot">&lt;-</span> <span class="cf">function</span>(pair_lambdas){</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  (pair_lambdas[<span class="dv">1</span>]<span class="sc">-</span><span class="dv">1</span>)<span class="sc">/</span>(pair_lambdas[<span class="dv">2</span>]<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>competitive ability:</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>BH_competitive_ability <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, pair_matrix){</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">all</span>(pair_matrix <span class="sc">&gt;=</span> <span class="dv">0</span>)){</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>    (lambda <span class="sc">-</span> <span class="dv">1</span>)<span class="sc">/</span><span class="fu">sqrt</span>(pair_matrix[<span class="dv">1</span>,<span class="dv">1</span>] <span class="sc">*</span> pair_matrix[<span class="dv">1</span>,<span class="dv">2</span>])</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    <span class="cn">NA_real_</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  }</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li>competitive effects and responses: these are obtained with an
optimization function <code>cxr_er_fit</code>, which is similar to
<code>cxr_pm_fit</code> (see vignette 1). We include at the end of this
vignette the complete model template for a custom effect and response
model. The formulation of the Beverton-Holt effect and response model is
simply</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>pred <span class="ot">&lt;-</span> lambda.part<span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span> e.part<span class="sc">*</span>r.part )</span></code></pre></div>
<p>where each part potentially depends on neighbour densities and
covariates.</p>
<ul>
<li>species fitness in the absence of niche differences:</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>BH_species_fitness <span class="ot">&lt;-</span> <span class="cf">function</span>(lambda, competitive_response){</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  (lambda<span class="dv">-1</span>)<span class="sc">/</span>competitive_response</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>}</span></code></pre></div>
<p>Therefore, in order to compute coexistence metrics based on your
custom population dynamics model, you should code your own versions of
these metrics, save them with appropriate names (i.e. changing the model
family acronym at the beginning of the functions), and source them in
the global environment, in order for the <code>cxr</code> interface to
be able to find and use them.</p>
<p><strong>Template for population dynamics models</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>family_pm_alpha_form_lambdacov_form_alphacov_form <span class="ot">&lt;-</span> <span class="cf">function</span>(par,</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>                                                              fitness,</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>                                                              <span class="at">neigh_intra_matrix =</span> <span class="cn">NULL</span>,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>                                                              neigh_inter_matrix,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>                                                              covariates,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>                                                              fixed_parameters){</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  </span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  </span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  <span class="co"># retrieve parameters -----------------------------------------------------</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  <span class="co"># parameters to fit are all in the &quot;par&quot; vector,</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="co"># so we need to retrieve them one by one</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="co"># order is {lambda,lambda_cov,alpha_intra,alpha_inter,alpha_cov,sigma}</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  </span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>  <span class="co"># comment or uncomment sections for the different parameters</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="co"># depending on whether your model includes them</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  <span class="co"># note that the section on alpha_inter includes two</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  <span class="co"># possibilities, depending on whether a single alpha is </span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>  <span class="co"># fitted for all interactions (global) or each pairwise alpha is </span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>  <span class="co"># different (pairwise)</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>  <span class="co"># both are commented, you need to uncomment the appropriate one</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>  </span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>  <span class="co"># likewise for the section on alpha_cov</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>  </span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>  <span class="co"># --------------------------------------------------------------------------</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>  </span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>  pos <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>  </span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>  <span class="co"># if a parameter is passed within the &quot;par&quot; vector,</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>  <span class="co"># it should be NULL in the &quot;fixed_parameters&quot; list</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>  </span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>  <span class="co"># lambda</span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters<span class="sc">$</span>lambda)){</span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>    lambda <span class="ot">&lt;-</span> par[pos]</span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>    lambda <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;lambda&quot;</span>]]</span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>  }</span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>  </span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>  <span class="co"># lambda_cov</span></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters<span class="sc">$</span>lambda_cov)){</span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>    lambda_cov <span class="ot">&lt;-</span> par[pos<span class="sc">:</span>(pos<span class="sc">+</span><span class="fu">ncol</span>(covariates)<span class="sc">-</span><span class="dv">1</span>)]</span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="fu">ncol</span>(covariates)</span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a>    lambda_cov <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;lambda_cov&quot;</span>]]</span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>  }</span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a>  </span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a>  <span class="co"># alpha_intra</span></span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(neigh_intra_matrix)){</span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a>    <span class="co"># intra</span></span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters[[<span class="st">&quot;alpha_intra&quot;</span>]])){</span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>      alpha_intra <span class="ot">&lt;-</span> par[pos]</span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a>      pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb11-53"><a href="#cb11-53" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb11-54"><a href="#cb11-54" tabindex="-1"></a>      alpha_intra <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;alpha_intra&quot;</span>]]</span>
<span id="cb11-55"><a href="#cb11-55" tabindex="-1"></a>    }</span>
<span id="cb11-56"><a href="#cb11-56" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-57"><a href="#cb11-57" tabindex="-1"></a>    alpha_intra <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb11-58"><a href="#cb11-58" tabindex="-1"></a>  }</span>
<span id="cb11-59"><a href="#cb11-59" tabindex="-1"></a>  </span>
<span id="cb11-60"><a href="#cb11-60" tabindex="-1"></a>  <span class="co"># alpha_inter</span></span>
<span id="cb11-61"><a href="#cb11-61" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters[[<span class="st">&quot;alpha_inter&quot;</span>]])){</span>
<span id="cb11-62"><a href="#cb11-62" tabindex="-1"></a>    <span class="co"># uncomment for alpha_global</span></span>
<span id="cb11-63"><a href="#cb11-63" tabindex="-1"></a>    <span class="co"># alpha_inter &lt;- par[pos]</span></span>
<span id="cb11-64"><a href="#cb11-64" tabindex="-1"></a>    <span class="co"># pos &lt;- pos + 1</span></span>
<span id="cb11-65"><a href="#cb11-65" tabindex="-1"></a>    </span>
<span id="cb11-66"><a href="#cb11-66" tabindex="-1"></a>    <span class="co"># uncomment for alpha_pairwise</span></span>
<span id="cb11-67"><a href="#cb11-67" tabindex="-1"></a>    <span class="co"># alpha_inter &lt;- par[pos:(pos+ncol(neigh_inter_matrix)-1)]</span></span>
<span id="cb11-68"><a href="#cb11-68" tabindex="-1"></a>    <span class="co"># pos &lt;- pos + ncol(neigh_inter_matrix)</span></span>
<span id="cb11-69"><a href="#cb11-69" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-70"><a href="#cb11-70" tabindex="-1"></a>    alpha_inter <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;alpha_inter&quot;</span>]]</span>
<span id="cb11-71"><a href="#cb11-71" tabindex="-1"></a>  }</span>
<span id="cb11-72"><a href="#cb11-72" tabindex="-1"></a>  </span>
<span id="cb11-73"><a href="#cb11-73" tabindex="-1"></a>  <span class="co"># alpha_cov</span></span>
<span id="cb11-74"><a href="#cb11-74" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters<span class="sc">$</span>alpha_cov)){</span>
<span id="cb11-75"><a href="#cb11-75" tabindex="-1"></a>    <span class="co"># uncomment for alpha_cov_global</span></span>
<span id="cb11-76"><a href="#cb11-76" tabindex="-1"></a>    <span class="co"># alpha_cov &lt;- par[pos:(pos+ncol(covariates)-1)]</span></span>
<span id="cb11-77"><a href="#cb11-77" tabindex="-1"></a>    <span class="co"># pos &lt;- pos + ncol(covariates)</span></span>
<span id="cb11-78"><a href="#cb11-78" tabindex="-1"></a>    </span>
<span id="cb11-79"><a href="#cb11-79" tabindex="-1"></a>    <span class="co"># uncomment for alpha_cov_pairwise</span></span>
<span id="cb11-80"><a href="#cb11-80" tabindex="-1"></a>    <span class="co"># alpha_cov &lt;- par[pos:(pos+(ncol(covariates)*</span></span>
<span id="cb11-81"><a href="#cb11-81" tabindex="-1"></a>    <span class="co"># (ncol(neigh_inter_matrix)+ncol(neigh_intra_matrix)))-1)]</span></span>
<span id="cb11-82"><a href="#cb11-82" tabindex="-1"></a>    <span class="co"># pos &lt;- pos + (ncol(covariates)*(ncol(neigh_inter_matrix)+ncol(neigh_intra_matrix)))</span></span>
<span id="cb11-83"><a href="#cb11-83" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb11-84"><a href="#cb11-84" tabindex="-1"></a>    alpha_cov <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;alpha_cov&quot;</span>]]</span>
<span id="cb11-85"><a href="#cb11-85" tabindex="-1"></a>  }</span>
<span id="cb11-86"><a href="#cb11-86" tabindex="-1"></a>  </span>
<span id="cb11-87"><a href="#cb11-87" tabindex="-1"></a>  <span class="co"># sigma - this is always necessary</span></span>
<span id="cb11-88"><a href="#cb11-88" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> par[<span class="fu">length</span>(par)]</span>
<span id="cb11-89"><a href="#cb11-89" tabindex="-1"></a>  </span>
<span id="cb11-90"><a href="#cb11-90" tabindex="-1"></a>  <span class="co"># now, parameters have appropriate values (or NULL)</span></span>
<span id="cb11-91"><a href="#cb11-91" tabindex="-1"></a>  <span class="co"># next section is where your model is coded</span></span>
<span id="cb11-92"><a href="#cb11-92" tabindex="-1"></a>  </span>
<span id="cb11-93"><a href="#cb11-93" tabindex="-1"></a>  <span class="co"># MODEL CODE HERE ---------------------------------------------------------</span></span>
<span id="cb11-94"><a href="#cb11-94" tabindex="-1"></a>  </span>
<span id="cb11-95"><a href="#cb11-95" tabindex="-1"></a>  <span class="co"># the model should return a &quot;pred&quot; value</span></span>
<span id="cb11-96"><a href="#cb11-96" tabindex="-1"></a>  <span class="co"># a function of lambda, alpha_intra, alpha_inter, lambda_cov, alpha_cov </span></span>
<span id="cb11-97"><a href="#cb11-97" tabindex="-1"></a>  <span class="co"># and neigh_intra_matrix, neigh_inter_matrix, and covariates</span></span>
<span id="cb11-98"><a href="#cb11-98" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-99"><a href="#cb11-99" tabindex="-1"></a>  </span>
<span id="cb11-100"><a href="#cb11-100" tabindex="-1"></a>  <span class="co"># MODEL CODE ENDS HERE ----------------------------------------------------</span></span>
<span id="cb11-101"><a href="#cb11-101" tabindex="-1"></a>  </span>
<span id="cb11-102"><a href="#cb11-102" tabindex="-1"></a>  <span class="co"># the routine returns the sum of log-likelihoods of the data and model:</span></span>
<span id="cb11-103"><a href="#cb11-103" tabindex="-1"></a>  <span class="co"># DO NOT CHANGE THIS</span></span>
<span id="cb11-104"><a href="#cb11-104" tabindex="-1"></a>  llik <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(fitness, <span class="at">mean =</span> (<span class="fu">log</span>(pred)), <span class="at">sd =</span> (sigma), <span class="at">log=</span><span class="cn">TRUE</span>)</span>
<span id="cb11-105"><a href="#cb11-105" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>llik))</span>
<span id="cb11-106"><a href="#cb11-106" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Template for effect and response models</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>family_er_lambdacov_form_effectcov_form_responsecov_form <span class="ot">&lt;-</span> <span class="cf">function</span>(par,</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>                                                                     fitness,</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>                                                                     target,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>                                                                     density,</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>                                                                     covariates,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>                                                                     fixed_parameters){</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  </span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  num.sp <span class="ot">&lt;-</span> <span class="fu">nrow</span>(target)</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>  </span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  <span class="co"># parameters to fit are all in the &quot;par&quot; vector,</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="co"># so we need to retrieve them one by one</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  <span class="co"># order is {lambda,lambda_cov,effect,effect_cov,response,response_cov,sigma}</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>  </span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>  <span class="co"># comment or uncomment sections for the different parameters</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>  <span class="co"># depending on whether your model includes them</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>  <span class="co"># note that effect and response models must always include</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>  <span class="co"># lambda, effect, and response, at least.</span></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>  </span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>  pos <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>  </span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>  <span class="co"># if a parameter is passed within the &quot;par&quot; vector,</span></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>  <span class="co"># it should be NULL in the &quot;fixed_parameters&quot; list</span></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>  </span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>  <span class="co"># lambda</span></span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters[[<span class="st">&quot;lambda&quot;</span>]])){</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>    lambda <span class="ot">&lt;-</span> par[pos<span class="sc">:</span>(pos <span class="sc">+</span> num.sp <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> num.sp</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>    lambda <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;lambda&quot;</span>]]</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>  }</span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>  </span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>  <span class="co"># lambda_cov</span></span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters<span class="sc">$</span>lambda_cov)){</span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>    <span class="co"># the covariate effects are more efficient in a matrix form</span></span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a>    <span class="co"># with species in rows (hence byrow = T, because by default</span></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a>    <span class="co"># the vector is sorted first by covariates)</span></span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>    lambda_cov <span class="ot">&lt;-</span> <span class="fu">matrix</span>(par[pos<span class="sc">:</span>(pos<span class="sc">+</span>(<span class="fu">ncol</span>(covariates)<span class="sc">*</span>num.sp)<span class="sc">-</span><span class="dv">1</span>)],</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>                         <span class="at">nrow =</span> num.sp,</span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a>                         <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="fu">ncol</span>(covariates)<span class="sc">*</span>num.sp</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a>    lambda_cov <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;lambda_cov&quot;</span>]]</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>  }</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a>  </span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a>  <span class="co"># effect</span></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters[[<span class="st">&quot;effect&quot;</span>]])){</span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a>    effect <span class="ot">&lt;-</span> par[pos<span class="sc">:</span>(pos <span class="sc">+</span> num.sp <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> num.sp</span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a>    effect <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;effect&quot;</span>]]</span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a>  }</span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a>  </span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a>  <span class="co"># effect_cov</span></span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters<span class="sc">$</span>effect_cov)){</span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a>    effect_cov <span class="ot">&lt;-</span> <span class="fu">matrix</span>(par[pos<span class="sc">:</span>(pos<span class="sc">+</span>(<span class="fu">ncol</span>(covariates)<span class="sc">*</span>num.sp)<span class="sc">-</span><span class="dv">1</span>)],</span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>                         <span class="at">nrow =</span> num.sp,</span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>                         <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="fu">ncol</span>(covariates)<span class="sc">*</span>num.sp</span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a>    effect_cov <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;effect_cov&quot;</span>]]</span>
<span id="cb12-61"><a href="#cb12-61" tabindex="-1"></a>  }</span>
<span id="cb12-62"><a href="#cb12-62" tabindex="-1"></a>  </span>
<span id="cb12-63"><a href="#cb12-63" tabindex="-1"></a>  <span class="co"># response</span></span>
<span id="cb12-64"><a href="#cb12-64" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters[[<span class="st">&quot;response&quot;</span>]])){</span>
<span id="cb12-65"><a href="#cb12-65" tabindex="-1"></a>    response <span class="ot">&lt;-</span> par[pos<span class="sc">:</span>(pos <span class="sc">+</span> num.sp <span class="sc">-</span> <span class="dv">1</span>)]</span>
<span id="cb12-66"><a href="#cb12-66" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> num.sp</span>
<span id="cb12-67"><a href="#cb12-67" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-68"><a href="#cb12-68" tabindex="-1"></a>    response <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;response&quot;</span>]]</span>
<span id="cb12-69"><a href="#cb12-69" tabindex="-1"></a>  }</span>
<span id="cb12-70"><a href="#cb12-70" tabindex="-1"></a>  </span>
<span id="cb12-71"><a href="#cb12-71" tabindex="-1"></a>  <span class="co"># response_cov</span></span>
<span id="cb12-72"><a href="#cb12-72" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(fixed_parameters[[<span class="st">&quot;response_cov&quot;</span>]])){</span>
<span id="cb12-73"><a href="#cb12-73" tabindex="-1"></a>    response_cov <span class="ot">&lt;-</span> <span class="fu">matrix</span>(par[pos<span class="sc">:</span>(pos<span class="sc">+</span>(<span class="fu">ncol</span>(covariates)<span class="sc">*</span>num.sp)<span class="sc">-</span><span class="dv">1</span>)],</span>
<span id="cb12-74"><a href="#cb12-74" tabindex="-1"></a>                           <span class="at">nrow =</span> num.sp,</span>
<span id="cb12-75"><a href="#cb12-75" tabindex="-1"></a>                           <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-76"><a href="#cb12-76" tabindex="-1"></a>    pos <span class="ot">&lt;-</span> pos <span class="sc">+</span> <span class="fu">ncol</span>(covariates)<span class="sc">*</span>num.sp</span>
<span id="cb12-77"><a href="#cb12-77" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb12-78"><a href="#cb12-78" tabindex="-1"></a>    response_cov <span class="ot">&lt;-</span> fixed_parameters[[<span class="st">&quot;response_cov&quot;</span>]]</span>
<span id="cb12-79"><a href="#cb12-79" tabindex="-1"></a>  }</span>
<span id="cb12-80"><a href="#cb12-80" tabindex="-1"></a>  </span>
<span id="cb12-81"><a href="#cb12-81" tabindex="-1"></a>  sigma <span class="ot">&lt;-</span> par[<span class="fu">length</span>(par)]</span>
<span id="cb12-82"><a href="#cb12-82" tabindex="-1"></a>  </span>
<span id="cb12-83"><a href="#cb12-83" tabindex="-1"></a>  <span class="co"># now, parameters have appropriate values (or NULL)</span></span>
<span id="cb12-84"><a href="#cb12-84" tabindex="-1"></a>  <span class="co"># next section is where your model is coded</span></span>
<span id="cb12-85"><a href="#cb12-85" tabindex="-1"></a>  </span>
<span id="cb12-86"><a href="#cb12-86" tabindex="-1"></a>  <span class="co"># MODEL CODE HERE ---------------------------------------------------------</span></span>
<span id="cb12-87"><a href="#cb12-87" tabindex="-1"></a>  </span>
<span id="cb12-88"><a href="#cb12-88" tabindex="-1"></a>  <span class="co"># the model should return a &quot;pred&quot; value</span></span>
<span id="cb12-89"><a href="#cb12-89" tabindex="-1"></a>  <span class="co"># a function of lambda, effect, response, lambda_cov, effect_cov, response_cov</span></span>
<span id="cb12-90"><a href="#cb12-90" tabindex="-1"></a>  pred <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb12-91"><a href="#cb12-91" tabindex="-1"></a>  </span>
<span id="cb12-92"><a href="#cb12-92" tabindex="-1"></a>  <span class="co"># MODEL CODE ENDS HERE ----------------------------------------------------</span></span>
<span id="cb12-93"><a href="#cb12-93" tabindex="-1"></a>  </span>
<span id="cb12-94"><a href="#cb12-94" tabindex="-1"></a>  <span class="co"># the routine returns the sum of log-likelihoods of the data and model:</span></span>
<span id="cb12-95"><a href="#cb12-95" tabindex="-1"></a>  <span class="co"># DO NOT CHANGE THIS</span></span>
<span id="cb12-96"><a href="#cb12-96" tabindex="-1"></a>  llik <span class="ot">&lt;-</span> <span class="fu">dnorm</span>(fitness, <span class="at">mean =</span> (<span class="fu">log</span>(pred)), <span class="at">sd =</span> (sigma), <span class="at">log=</span><span class="cn">TRUE</span>)</span>
<span id="cb12-97"><a href="#cb12-97" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">sum</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>llik))</span>
<span id="cb12-98"><a href="#cb12-98" tabindex="-1"></a>  </span>
<span id="cb12-99"><a href="#cb12-99" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>References</strong></p>
<p>Godoy, O., &amp; Levine, J. M. (2014). Phenology effects on invasion
success: insights from coupling field experiments to coexistence theory.
Ecology, 95(3), 726-736.</p>
<p>Hart, S. P., Freckleton, R. P., &amp; Levine, J. M. (2018). How to
quantify competitive ability. Journal of Ecology, 106(5), 1902-1909.</p>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
